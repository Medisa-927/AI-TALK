<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI èªéŸ³å°è©±ç¶²é </title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        #chat { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px #ccc; }
        .msg { margin: 10px 0; }
        .user { color: #0078d7; }
        .ai { color: #d77a00; }
        #mic { font-size: 2em; cursor: pointer; }
        #mic.listening { color: red; }
        #error { color: red; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="chat">
        <h2>AI èªéŸ³å°è©±</h2>
        <div style="margin-bottom: 10px;">
            <input id="apiKeyInput" type="text" placeholder="è«‹è¼¸å…¥ Google API é‡‘é‘°" style="width:60%">
            <button id="setApiKeyBtn">å•Ÿç”¨é‡‘é‘°</button>
        </div>
        <div id="messages"></div>
        <button id="mic" disabled>ğŸ¤</button>
        <div id="error"></div>
    </div>
    <script>
    let GOOGLE_API_KEY = '';
    let AI_API_URL = '';

    const micBtn = document.getElementById('mic');
    const messagesDiv = document.getElementById('messages');
    const errorDiv = document.getElementById('error');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const setApiKeyBtn = document.getElementById('setApiKeyBtn');
    let recognizing = false;
    let recognition;

    function setApiKey() {
        GOOGLE_API_KEY = apiKeyInput.value.trim();
        if (GOOGLE_API_KEY) {
            AI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + GOOGLE_API_KEY;
            errorDiv.textContent = '';
            micBtn.disabled = false;
            micBtn.textContent = 'ğŸ¤';
            addMessage('ç³»çµ±', 'è«‹é»æ“Šéº¥å…‹é¢¨é–‹å§‹èªéŸ³å°è©±', 'user');
        } else {
            errorDiv.textContent = 'è«‹è¼¸å…¥æœ‰æ•ˆçš„ Google API é‡‘é‘°';
            micBtn.disabled = true;
            micBtn.textContent = 'è«‹å¡« API é‡‘é‘°';
        }
    }

    setApiKeyBtn.onclick = setApiKey;
    apiKeyInput.onkeydown = function(e) { if (e.key === 'Enter') setApiKey(); };

    window.onload = function() {
        micBtn.disabled = true;
        micBtn.textContent = 'è«‹å¡« API é‡‘é‘°';
        addMessage('ç³»çµ±', 'è«‹å…ˆè¼¸å…¥ Google API é‡‘é‘°ä¸¦å•Ÿç”¨', 'user');
    };

    // èªéŸ³è¾¨è­˜åˆå§‹åŒ–
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.lang = 'zh-TW';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onstart = function() {
            recognizing = true;
            micBtn.classList.add('listening');
            errorDiv.textContent = '';
        };
        recognition.onend = function() {
            recognizing = false;
            micBtn.classList.remove('listening');
        };
        recognition.onerror = function(event) {
            errorDiv.textContent = 'èªéŸ³è¾¨è­˜éŒ¯èª¤: ' + event.error;
        };
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            addMessage('ä½ ', transcript, 'user');
            sendToAI(transcript);
        };
    } else {
        micBtn.disabled = true;
        micBtn.textContent = 'ä¸æ”¯æ´èªéŸ³';
        errorDiv.textContent = 'æœ¬ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜';
    }

    micBtn.onclick = function() {
        if (!GOOGLE_API_KEY) {
            errorDiv.textContent = 'è«‹å…ˆè¼¸å…¥ Google API é‡‘é‘°';
            return;
        }
        if (recognizing) {
            recognition.stop();
        } else {
            recognition.start();
        }
    };

    function addMessage(sender, text, cls) {
        const div = document.createElement('div');
        div.className = 'msg ' + cls;
        div.innerHTML = `<b>${sender}:</b> ${text}`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function sendToAI(text) {
        if (!GOOGLE_API_KEY) {
            errorDiv.textContent = 'è«‹å…ˆè¼¸å…¥ Google API é‡‘é‘°';
            return;
        }
        addMessage('AI', 'æ€è€ƒä¸­...', 'ai');
        fetch(AI_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text }] }]
            })
        })
        .then(res => res.json())
        .then(data => {
            let aiMsg = 'AI æ²’æœ‰å›æ‡‰';
            if (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                aiMsg = data.candidates[0].content.parts[0].text;
            } else if (data.error && data.error.message) {
                aiMsg = 'API éŒ¯èª¤: ' + data.error.message;
            }
            addMessage('AI', aiMsg, 'ai');
            speak(aiMsg);
        })
        .catch((err) => {
            addMessage('AI', 'ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚', 'ai');
            errorDiv.textContent = 'API è«‹æ±‚å¤±æ•—: ' + err;
        });
    }

    // AI èªéŸ³å›æ‡‰
    function speak(text) {
        if ('speechSynthesis' in window) {
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'zh-TW';
            window.speechSynthesis.speak(utter);
        }
    }
    </script>
</body>
</html>
