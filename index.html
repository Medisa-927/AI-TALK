<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 語音對話網頁</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        #chat { max-width: 600px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px #ccc; }
        .msg { margin: 10px 0; }
        .user { color: #0078d7; }
        .ai { color: #d77a00; }
        #mic { font-size: 2em; cursor: pointer; }
        #mic.listening { color: red; }
        #error { color: red; margin-top: 10px; }
    </style>
</head>
<body>
    <div id="chat">
        <h2>AI 語音對話</h2>
        <div style="margin-bottom: 10px;">
            <input id="apiKeyInput" type="text" placeholder="請輸入 Google API 金鑰" style="width:60%">
            <button id="setApiKeyBtn">啟用金鑰</button>
        </div>
        <div id="messages"></div>
        <button id="mic" disabled>🎤</button>
        <div id="error"></div>
    </div>
    <script>
    let GOOGLE_API_KEY = '';
    let AI_API_URL = '';

    const micBtn = document.getElementById('mic');
    const messagesDiv = document.getElementById('messages');
    const errorDiv = document.getElementById('error');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const setApiKeyBtn = document.getElementById('setApiKeyBtn');
    let recognizing = false;
    let recognition;

    function setApiKey() {
        GOOGLE_API_KEY = apiKeyInput.value.trim();
        if (GOOGLE_API_KEY) {
            AI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + GOOGLE_API_KEY;
            errorDiv.textContent = '';
            micBtn.disabled = false;
            micBtn.textContent = '🎤';
            addMessage('系統', '請點擊麥克風開始語音對話', 'user');
        } else {
            errorDiv.textContent = '請輸入有效的 Google API 金鑰';
            micBtn.disabled = true;
            micBtn.textContent = '請填 API 金鑰';
        }
    }

    setApiKeyBtn.onclick = setApiKey;
    apiKeyInput.onkeydown = function(e) { if (e.key === 'Enter') setApiKey(); };

    window.onload = function() {
        micBtn.disabled = true;
        micBtn.textContent = '請填 API 金鑰';
        addMessage('系統', '請先輸入 Google API 金鑰並啟用', 'user');
    };

    // 語音辨識初始化
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.lang = 'zh-TW';
        recognition.continuous = false;
        recognition.interimResults = false;

        recognition.onstart = function() {
            recognizing = true;
            micBtn.classList.add('listening');
            errorDiv.textContent = '';
        };
        recognition.onend = function() {
            recognizing = false;
            micBtn.classList.remove('listening');
        };
        recognition.onerror = function(event) {
            errorDiv.textContent = '語音辨識錯誤: ' + event.error;
        };
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            addMessage('你', transcript, 'user');
            sendToAI(transcript);
        };
    } else {
        micBtn.disabled = true;
        micBtn.textContent = '不支援語音';
        errorDiv.textContent = '本瀏覽器不支援語音辨識';
    }

    micBtn.onclick = function() {
        if (!GOOGLE_API_KEY) {
            errorDiv.textContent = '請先輸入 Google API 金鑰';
            return;
        }
        if (recognizing) {
            recognition.stop();
        } else {
            recognition.start();
        }
    };

    function addMessage(sender, text, cls) {
        const div = document.createElement('div');
        div.className = 'msg ' + cls;
        div.innerHTML = `<b>${sender}:</b> ${text}`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function sendToAI(text) {
        if (!GOOGLE_API_KEY) {
            errorDiv.textContent = '請先輸入 Google API 金鑰';
            return;
        }
        addMessage('AI', '思考中...', 'ai');
        fetch(AI_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text }] }]
            })
        })
        .then(res => res.json())
        .then(data => {
            let aiMsg = 'AI 沒有回應';
            if (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                aiMsg = data.candidates[0].content.parts[0].text;
            } else if (data.error && data.error.message) {
                aiMsg = 'API 錯誤: ' + data.error.message;
            }
            addMessage('AI', aiMsg, 'ai');
            speak(aiMsg);
        })
        .catch((err) => {
            addMessage('AI', '發生錯誤，請稍後再試。', 'ai');
            errorDiv.textContent = 'API 請求失敗: ' + err;
        });
    }

    // AI 語音回應
    function speak(text) {
        if ('speechSynthesis' in window) {
            const utter = new SpeechSynthesisUtterance(text);
            utter.lang = 'zh-TW';
            window.speechSynthesis.speak(utter);
        }
    }
    </script>
</body>
</html>
